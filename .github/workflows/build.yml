name: Build Windows EXE

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up MSVC environment and compile
        shell: pwsh
        run: |
          $vswhere = "$env:ProgramFiles(x86)\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) {
            Write-Error "vswhere not found; cannot locate Visual Studio"
            exit 1
          }
          $instPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (-not $instPath) {
            Write-Error "No Visual Studio installation with VC tools found"
            exit 1
          }
          $vcvars = Join-Path $instPath "VC\Auxiliary\Build\vcvars64.bat"
          if (-not (Test-Path $vcvars)) {
            Write-Error "vcvars64.bat not found at $vcvars"
            exit 1
          }
          cmd /c "`"$vcvars`" x64 && cl /Fe:main.exe /EHsc macro.cpp user32.lib"

      - name: Upload EXE
        uses: actions/upload-artifact@v4
        with:
          name: macro-exe
          path: main.exe
